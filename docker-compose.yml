services:
  # Vespa vector search engine
  vespa:
    image: vespaengine/vespa:latest
    container_name: vespa-singlenode
    ports:
      - "8080:8080" # Vespa query API
      - "19071:19071" # Vespa config server
    volumes:
      - vespa_data:/opt/vespa/var
      - ./vespa-app:/vespa-app
    networks:
      - vespa_network
    # Run Vespa in single-node mode
    command: ["vespa", "run", "--model", "singlenode"]

  # Node.js API application
  app:
    build:
      context: ./app
      dockerfile: ../Dockerfile
    container_name: vespa-node-app
    ports:
      - "3000:3000"
    environment:
      - VESPA_HOST=vespa
      - VESPA_PORT=8080
    networks:
      - vespa_network
    depends_on:
      - vespa
    # Wait for Vespa to be ready before starting
    command: sh -c "sleep 30 && npm start"

volumes:
  vespa_data:
    driver: local

networks:
  vespa_network:
    driver: bridge
